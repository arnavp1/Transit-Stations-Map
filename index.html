<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Transit Stations Map</title>
  <meta name="viewport" content="initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
    }

    #controls {
      margin: 10px 20px;
    }

    #map {
      height: 90vh;
      width: 100vw;
    }

    select, input[type="text"] {
      margin-right: 8px;
      padding: 4px;
    }

    #controls label {
      display: inline-block;
      margin-bottom: 6px;
    }

    #legend {
      background: #fff;
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,.3);
      font-size: 14px;
    }

    #legend div {
      margin-bottom: 4px;
    }

    #debug {
      background: #f0f0f0;
      padding: 10px;
      margin: 10px 20px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

  <h3 style="margin:10px 20px 0">Transit Stations Map</h3>
  
  <div id="debug">
    <strong>Debug Info:</strong><br>
    <div id="debugOutput">Initializing...</div>
  </div>

  <!-- Filters -->
  <div id="controls">
    <label>State:
      <select id="stateFilter">
        <option value="">All</option>
        <option value="CA" selected>California</option>
      </select>
    </label>

    <label>Mode:
      <select id="modeFilter">
        <option value="">All</option>
        <option value="bus">Bus</option>
        <option value="air">Air</option>
        <option value="rail">Rail</option>
        <option value="ferry">Ferry</option>
        <option value="bike">Bike</option>
      </select>
    </label>

    <label>Search:
      <input type="text" id="nameSearch" placeholder="Name contains‚Ä¶">
    </label>

    <br>

    <label>
      <input type="checkbox" id="toggleMarkers" checked> Show Station Markers
    </label>

    <label>
      <input type="checkbox" id="toggleRoutes"> Show Transit Lines
    </label>

    <label>
      <input type="checkbox" id="toggleBottlenecks"> Show Bottlenecks
    </label>

    <label>
      <input type="checkbox" id="toggleLowIncome"> Show Low-Income Areas
    </label>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Legend -->
  <div id="legend">
    <b>Legend</b><br>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png"> Bus</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png"> Air</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/green-dot.png"> Rail</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"> Ferry</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/purple-dot.png"> Bike</div>
    <div style="color:#6a1b9a;">‚ñ† Low-Income Areas</div>
    <div style="color:#FF5733;">‚ñ† Bottlenecks</div>
  </div>

  <script>
    let map, markers = [], stationData = [];
    let routeLayer = null;
    let bottleneckLayer = null;
    let lowIncomeLayer = null;
    const typeMap = { 1: "Bus", 2: "Rail", 5: "Ferry", 10: "Air" };

    function debugLog(message) {
      console.log(message);
      const debugDiv = document.getElementById("debugOutput");
      debugDiv.innerHTML += message + "<br>";
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    function primaryMode(st) {
      if (+st.mode_bus)   return "bus";
      if (+st.mode_air)   return "air";
      if (+st.mode_rail)  return "rail";
      if (+st.mode_ferry) return "ferry";
      if (+st.mode_bike)  return "bike";
      return (typeMap[+st.mode_type] || "unknown").toLowerCase();
    }

    function modeIcon(mode) {
      const color = {
        bus: "red", air: "blue", rail: "green",
        ferry: "yellow", bike: "purple"
      }[mode] || "orange";
      return `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`;
    }

    function fmtAddress(st) {
      return [st.address, st.city, st.state, st.zipcode]
        .filter(Boolean).join(", ");
    }

    function popupHTML(st) {
      const modes = [
        +st.mode_bus   ? "üöå Bus"   : null,
        +st.mode_air   ? "‚úàÔ∏è Air"   : null,
        +st.mode_rail  ? "üöÜ Rail"  : null,
        +st.mode_ferry ? "‚õ¥Ô∏è Ferry" : null,
        +st.mode_bike  ? "üö≤ Bike"  : null
      ].filter(Boolean).join(" | ") || (typeMap[+st.mode_type] || "");

      const url = st.website?.startsWith("http") ? st.website : `https://${st.website}`;

      return `
        <b>${st.fac_name || st.station_id}</b><br>
        <b>ID:</b> ${st.station_id}<br>
        <b>Address:</b> ${fmtAddress(st)}<br>
        <b>Modes:</b> ${modes}<br>
        ${st.website ? `<a href="${url}" target="_blank" rel="noopener noreferrer">Website</a><br>` : ""}
        ${st.notes ? `<i>${st.notes}</i><br>` : ""}
      `;
    }

    function clearMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    function drawMarkers(arr) {
      clearMarkers();
      debugLog(`Drawing ${arr.length} markers`);
      
      arr.forEach(st => {
        const lat = parseFloat(st.latitude);
        const lng = parseFloat(st.longitude);
        const mode = primaryMode(st);

        const m = new google.maps.Marker({
          position: { lat, lng },
          map,
          icon: modeIcon(mode),
          title: `${st.fac_name || st.station_id} (${mode})`
        });

        const iw = new google.maps.InfoWindow({ content: popupHTML(st) });
        m.addListener("click", () => iw.open(map, m));
        markers.push(m);
      });
    }

    function filtered() {
      const state = document.getElementById("stateFilter").value;
      const mode  = document.getElementById("modeFilter").value;
      const name  = document.getElementById("nameSearch").value.toLowerCase();
      return stationData.filter(st => {
        if (state && st.state !== state) return false;
        if (mode  && primaryMode(st) !== mode) return false;
        if (name  && !(st.fac_name || "").toLowerCase().includes(name)) return false;
        return true;
      });
    }

    function update() {
      drawMarkers(filtered());
    }

    function loadRoutesLayer() {
      if (routeLayer) {
        routeLayer.setMap(map);  // Re-show
        return;
      }

      fetch("/api/routes/geojson?state=CA")
        .then(res => res.json())
        .then(geojson => {
          routeLayer = new google.maps.Data({ map });

          routeLayer.addGeoJson(geojson);

          routeLayer.setStyle(feature => {
            const type = feature.getProperty("route_type");
            const colors = {
              "1": "#e41a1c",
              "2": "#377eb8",
              "3": "#4daf4a",
              "default": "#888"
            };
            return {
              strokeColor: colors[type] || colors.default,
              strokeWeight: 2
            };
          });

          routeLayer.setMap(map);
        })
        .catch(error => {
          debugLog("Error loading routes: " + error.message);
        });
    }

    function hideRoutesLayer() {
      if (routeLayer) {
        routeLayer.setMap(null);
      }
    }

    function loadBottlenecksLayer() {
      if (bottleneckLayer) {
        bottleneckLayer.setMap(map);
        return;
      }

      fetch("/api/bottle/geojson")
        .then(res => res.json())
        .then(geojson => {
          bottleneckLayer = new google.maps.Data({ map });

          bottleneckLayer.addGeoJson(geojson);

          bottleneckLayer.setStyle({
            strokeColor: "#FF5733",
            strokeWeight: 2,
            fillColor: "#FF5733",
            fillOpacity: 0.5
          });

          bottleneckLayer.setMap(map);
        })
        .catch(err => debugLog("Error loading bottlenecks: " + err));
    }

    function hideBottlenecksLayer() {
      if (bottleneckLayer) {
        bottleneckLayer.setMap(null);
      }
    }

    function loadLowIncomeLayer() {
      if (lowIncomeLayer) {
        lowIncomeLayer.setMap(map);
        return;
      }

      fetch("/api/lowincome/geojson")
        .then(res => res.json())
        .then(geojson => {
          lowIncomeLayer = new google.maps.Data({ map });

          lowIncomeLayer.addGeoJson(geojson);

          lowIncomeLayer.setStyle({
            strokeColor: "#6a1b9a",
            strokeWeight: 1.5,
            fillColor: "#6a1b9a",
            fillOpacity: 0.3
          });

          lowIncomeLayer.setMap(map);
        })
        .catch(err => debugLog("Error loading low-income layer: " + err));
    }

    function hideLowIncomeLayer() {
      if (lowIncomeLayer) {
        lowIncomeLayer.setMap(null);
      }
    }


    window.initMap = function() {
      fetch("/api/stations?state=CA")
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          stationData = data;

          map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 36.7783, lng: -119.4179 },  // CA center
            zoom: 6
          });

          map.controls[google.maps.ControlPosition.RIGHT_BOTTOM]
            .push(document.getElementById("legend"));

          document.getElementById("toggleMarkers").onchange = e => {
            const show = e.target.checked;
            markers.forEach(m => m.setMap(show ? map : null));
          };

          document.getElementById("toggleRoutes").onchange = e => {
            if (e.target.checked) loadRoutesLayer();
            else hideRoutesLayer();
          };

          document.getElementById("toggleBottlenecks").onchange = e => {
            if (e.target.checked) loadBottlenecksLayer();
            else hideBottlenecksLayer();
          };

          const states = [...new Set(stationData.map(s => s.state))].filter(Boolean).sort();
          states.forEach(s => {
            const opt = document.createElement("option");
            opt.value = opt.text = s;
            document.getElementById("stateFilter").appendChild(opt);
          });

          document.getElementById("stateFilter").onchange = update;
          document.getElementById("modeFilter").onchange = update;
          document.getElementById("nameSearch").oninput = update;

          update();
        })
        .catch(error => {
          debugLog(`Error loading station data: ${error.message}`);
        });
    };
  </script>

  <script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap&loading=async">
  </script>
</body>
</html>
